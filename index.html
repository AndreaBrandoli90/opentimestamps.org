<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>OpenTimestamps</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="http://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

    <!-- Navigation -->
    <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>
    <nav id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
            <li class="sidebar-brand">
                <a href="#top" onclick=$("#menu-close").click();>OpenTimestamps</a>
            </li>
            <li>
                <a href="#top" onclick=$("#menu-close").click();>Home</a>
            </li>
            <li>
                <a href="#about" onclick=$("#menu-close").click();>About</a>
            </li>
            <li>
                <a href="#verify" onclick=$("#menu-close").click();>Verify</a>
            </li>
            <li>
                <a href="#howitworks" onclick=$("#menu-close").click();>How it works?</a>
            </li>
            <li>
                <a href="#vendors" onclick=$("#menu-close").click();>Vendors</a>
            </li>
            <li>
                <a href="#libraries" onclick=$("#menu-close").click();>Libraries</a>
            </li>
        </ul>
    </nav>

    <!-- Header -->
    <header id="top" class="header">
        <div class="text-vertical-center">
          <div class="title">
            <h1>Open<wbr>Timestamps</h1>
            <h3>A standard format for timestamping proofs</h3>
          </div>
        </div>
    </header>

    <!-- About -->
    <section id="about" class="about">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <h2>Open<wbr>Timestamps</h2>
                    <p class="lead">OpenTimestamps aims to be a standard format for blockchain timestamping.<br>
                      The format is flexible enough to be vendor and blockchain independent. <a href="#howitworks">Tell me more...</a>
                    </p>
                </div>
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
    </section>

    <!-- Services -->
    <!-- The circle icons use Font Awesome's stacked icon classes. For more information, visit http://fontawesome.io/examples/ -->
    <section id="services" class="services bg-primary">
        <div class="container">
            <div class="row text-center">
                <div class="col-lg-10 col-lg-offset-1">
                    <div class="row">
                        <div class="col-md-3 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-check fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Verify</strong>
                                </h4>
                                <p>Use the online verifier to check your stamp proof.</p>
                                <a href="#verify" class="btn btn-light">VERIFY</a>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-question fa-stack-1x text-primary"></i>
                                </span>

                                <h4>
                                    <strong>How it works?</strong>
                                </h4>
                                <p>Let me know the details on how the format works.</p>
                                <a href="#howitworks" class="btn btn-light">HOW IT WORKS</a>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-flask fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Vendors</strong>
                                </h4>
                                <p>What are the services in production that are adopting this standard?</p>
                                <a href="#vendors" class="btn btn-light">VENDORS</a>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-book fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Libraries</strong>
                                </h4>
                                <p>I want to adopt OpenTimestamps, show me working code!</p>
                                <a href="#libraries" class="btn btn-light">LIBRARIES</a>
                            </div>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.col-lg-10 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
    </section>


    <section id="verify">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1 text-center">
                    <br><h2>Verify</h2>
                    <hr class="small">
                    <div class="row">
                        <div class="col-sm-6">
                            <div>
                                <h3>1. Calculate hash</h3>

                                <div id="holder" >
                                    <div class="text-center">
                                        <br><span id="filename">Drop here a document</span>
                                        <br><span id="filesize">Or click to select one</span>
                                    </div>
                                </div>
                                <p>The hash is calculated on your browser preserving your privacy</p>
                                <input id="myInput" type="file" style="display:none">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div>
                                <h3>2. Paste Open<wbr>Timestamp</h3>
                                <br>
                                <textarea class="form-control" rows="4" id="jsonstamp"></textarea>

                            </div>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                    <p id="status" class="wrap" style="margin-bottom: 0px"></p>
                    <br><a href="#" class="btn btn-dark" id="verifyButton">VERIFY</a>
                    <br><br>
                    <div class="alert alert-warning" role="alert" id="alertMessage" style="display:none">
                    </div>
                    <div class="alert alert-success" role="alert" id="successMessage" style="display:none">
                    </div>
                    <div class="alert alert-danger" role="alert" id="dangerMessage" style="display:none">
                    </div>

                </div>
                <!-- /.col-lg-10 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
        <br><br>
    </section>


    <section id="howitworks" class="bg-primary">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1 text-center">
                    <br><h2>How it Works?</h2>
                    <hr class="small">
                </div>
                <div class="col-lg-10 col-lg-offset-1">
                    <p>
                      OpenTimestamps format define a path of operation from the timestamped data to the hash of a block in a blockchain.<br>
                      The existence of the path is the proof that the data is committed to the blockchain in that specific block.<br>
                      The commitment in the blockchain grants the data are created on or before the block timestamp.<br>
                      At the moment the bitcoin blockchain is the only one supported but there is no issue in extending the format to other blockchains.<br>
                      The stamp use <a href="http://json.org" style="color:white">json</a> as data-interchange format and the schema is the following.
                    </p>

                      <br>
                      <h4 id="schema">Schema:</h4>
                      <ul>
                        <li>Array of</li>
                        <ul>
                          <li>Array of</li>
                          <ul>
                            <li><a href="#pathstep"><code class="highlighter-rouge">Path Step</code></a></li>
                          </ul>
                        </ul>
                        <ul>
                          <li>Array of</li>
                          <ul>
                            <li><a href="#finalstep"><code class="highlighter-rouge">Final Step</code></a></li>
                          </ul>
                        </ul>
                      </ul>
                      <br>

                      <h4 id="pathstep">Path Step:</h4>
                      <p>The path contain the operation type, eventual prefix and suffix of data to append to the value obtained by the previous step in the path.
                        The first step has the document data as input.</p>
                      <ul>
                        <li><code class="highlighter-rouge">Path Operation</code> contains the operation executed in the step. It could be easily extended with other standard functions (like other hash functions)</li>
                        <ul>
                          <li>sha256</li>
                          <li>ripemd160</li>
                          <li>reverse</li>
                        </ul>
                        <li><code class="highlighter-rouge">Prefix</code></li>
                        <li><code class="highlighter-rouge">Suffix</code></li>
                      </ul>

                      <br>
                      <h4 id="finalstep">Final Step:</h4>
                      <ul>
                        <li><code class="highlighter-rouge">Blockchain Object</code> obtained by executing the path.</li>
                        <ul>
                          <li>block_header</li>
                        </ul>
                        <li><code class="highlighter-rouge">Which Blockchain</code></li>
                        <ul>
                          <li>bitcoin-mainnet</li>
                        </ul>
                        <li><code class="highlighter-rouge">Prefix</code></li>
                        <li><code class="highlighter-rouge">Suffix</code></li>
                      </ul>

                      <br>

                      <h4>OpenTimestamp example:</h4>

<div class="container">
    <ul class="nav nav-tabs">
        <li class="nav active"><a href="#A" data-toggle="tab">File format</a></li>
        <li class="nav"><a href="#B" data-toggle="tab">Network format</a></li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content">
        <div class="tab-pane fade in active" id="A">
          <figure class="highlight" style="height:350px; overflow:auto">
<pre><code class="language-shell" data-lang="shell"><span class="o">OpenTimestamps Proof</span>
<span class="o">v0.1</span>
<span class="o">[</span>
  <span class="o">[</span>
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,   <span class="c"># hash the input data with sha256, obtaining 78e4400495668c2984752aaafe06c28e64bf6b4182d9bd976aae48bb294121ea</span>
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,  <span class="c"># hash the result of the previous step prepended by the following prefix</span>
      <span class="s2">"1a2599c68b10dc0e2429af84eb6d84d7608d6fe65783a0e708fe8f1a1aa6cb06"</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"ripemd160"</span>,  <span class="c"># hash the previous step result with ripemd160 (in this case finding the address used in the bitcoin tx)</span>
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,   <span class="c"># hash the previous step result prepended and suffixed by the following which are the missing part of the bitcoin tx</span>
      <span class="s2">"0100000001545998db8b1958d9f2851f2f60011726423a7b559b69b106368c936050e91eff010000006a47304402202e699adf61fbed11fd44d777f719b4bba7427d6168e53431d172ca527dc34a720220731a425efbde3778fc27e5c511cba87ae300694f5ef5b9b154e0d9b1a16cfa190121034985ce697016d2aea060dd142886c875bb834d1fbe919e62529f49e23ae0005ffeffffff0270170000000000001976a914"</span>,
      <span class="s2">"88ac8bc80200000000001976a914d568233da83dd0c901982af78609a8c2af3f57af88acc0520600"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,  <span class="c"># hash the previous step result again, finding tx id</span>
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,  <span class="c"># the next steps are for finding the bitcoin block merkle root</span>
      <span class="s2">"d4079bd871b948aac583624213a70ee2d13a0cd047c69826ede68f1e0f48f8e6"</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"517d1c48146bd9339e5976c040a4cc6538159dd0c7dde0e0dcd3744cfe786e27"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">"1c19ecb00323dc30abcf164ae1ca9a3bec450a0d54480ab8c41bef4a895e7a76"</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"d701150b9b68e7c4f8313b9175b1b6d09d580baf169bc1ac5df56ba7b4457e20"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"42c8f3b497cb54f7c841eae8dd0635f54a9177c5568c52237f8eab2b30b235a0"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">"600f4259d4a321a54d962bfff9a3fae3d41563fb58ed00ca815dc84c643b7fc8"</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"72f449e5cf1ec52af3323ee1ae2e6016e1f1a4f538250d73fdbf6feaed6f758e"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"ff67072d9c67c9bf9949766d1a89ee8ba91df85d8f367d9fda5cd4e916f089fa"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"e9c4cdecf23a3787f0062a79e599a851d0d0d03d6c0f4ec1a5ab74c58eb2b8c8"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"57276146c3621e9db77e20b2faf625e53d935436aee0391369cd81932093d9a6"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">"aa9900285ae3dbb30024761c48ac1dda8cc04ef14b30341b342ad9f44cecdd43"</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,
      <span class="s2">"74079e5c0bc140e22ccc6a494dc6a402fd375cf198b099d0b0e9090e6646809e"</span>,
      <span class="s2">""</span>
    <span class="o">]</span>,
    <span class="o">[</span>
      <span class="s2">"sha256"</span>,   <span class="c"># After this last operation the result is the merkle root</span>
      <span class="s2">""</span>,
      <span class="s2">""</span>
    <span class="o">]</span>
  <span class="o">]</span>,
  <span class="o">[</span>
    <span class="s2">"block_header"</span>,   <span class="c"># In this last we obtain the bitcoin block header, by double hashing it we obtain the block hash</span>
    <span class="s2">"bitcoin-mainnet"</span>,
    <span class="s2">"04000000fb312a4a8035922bb03a1d53a400f5aef6706eae843b7d040000000000000000"</span>,
    <span class="s2">"9e0b50573684051839660b0d"</span>
  <span class="o">]</span>
<span class="o">]</span>
          </code>
          </pre>
          </figure>
        </div>
        <div class="tab-pane fade" id="B">Content inside tab B</div>
    </div>
</div>






                </div>
                <!-- /.col-lg-10 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
        <br><br>
    </section>


    <section id="vendors">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1 text-center">
                    <br><h2>Vendors</h2>
                    <hr class="small">
                    <div class="row">
                        <div class="col-sm-6">
                            <div>
                              <a href="http://eternitywall.it/notarize">
                                <h3>Eternity Wall</h3>
                                <img src="https://eternitywall.it/img/eternity_logo_final.svg" width="100"></img>
                              </a>
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div>
                                <h3>Your company here</h3>
                                <a href="https://github.com/RCasatta/web-opentimestamps/edit/master/index.html" class="btn btn-dark">ADD</a>
                            </div>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.col-lg-10 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
        <br><br>
    </section>


    <section id="libraries" class="bg-primary">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1 text-center">
                    <br><h2>Libraries</h2>
                    <hr class="small">
                    <div class="row">
                        <div class="col-sm-6">
                            <div>
                                <h3>python-opentimestamp</h3>
                                <p>The original python library from Peter Todd</p>
                                <a href="https://github.com/petertodd/python-opentimestamps"><i class="fa fa-github fa-fw fa-inverse fa-3x"></i></a>

                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div>
                                <h3>javascript</h3>
                                <p>The js code running in this page to make in browser verification</p>
                                <a href="https://github.com/RCasatta/web-opentimestamps"><i class="fa fa-github fa-fw fa-inverse fa-3x"></i></a>
                            </div>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                </div>
                <!-- /.col-lg-10 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
        <br><br>
    </section>


    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1 text-center">
                    <h4><strong>OpenTimestamps</strong>
                    </h4>

                    <ul class="list-unstyled">

                        <li><i class="fa fa-envelope-o fa-fw"></i> <a href="mailto:info@opentimestamps.com">info@opentimestamps.com</a>
                        </li>
                    </ul>
                    <br>
                    <ul class="list-inline">

                        <li>
                            <a href="https://github.com/RCasatta/web-opentimestamps"><i class="fa fa-github fa-fw fa-3x"></i></a>
                        </li>
                    </ul>
                    <hr class="small">

                </div>
            </div>
        </div>
        <a id="to-top" href="#top" class="btn btn-dark btn-lg"><i class="fa fa-chevron-up fa-fw fa-1x"></i></a>
    </footer>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <script src="bower_components/bitcore-lib/bitcore-lib.min.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    <script src="js/crypto.js"></script>

    <!-- Custom Theme JavaScript -->
    <script>
    var bitcore = require('bitcore-lib');
    // Closes the sidebar menu
    $("#menu-close").click(function(e) {
        e.preventDefault();
        $("#sidebar-wrapper").toggleClass("active");
    });
    // Opens the sidebar menu
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#sidebar-wrapper").toggleClass("active");
    });
    // Scrolls to the selected menu item on the page
    $(function() {
        $('a[href*=#]:not([href=#],[data-toggle],[data-target],[data-slide])').click(function() {
            if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') || location.hostname == this.hostname) {
                var target = $(this.hash);
                target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                if (target.length) {
                    $('html,body').animate({
                        scrollTop: target.offset().top
                    }, 1000);
                    return false;
                }
            }
        });
    });
    //#to-top button appears after scrolling
    var fixed = false;
    $(document).scroll(function() {
        if ($(this).scrollTop() > 250) {
            if (!fixed) {
                fixed = true;
                // $('#to-top').css({position:'fixed', display:'block'});
                $('#to-top').show("slow", function() {
                    $('#to-top').css({
                        position: 'fixed',
                        display: 'block'
                    });
                });
            }
        } else {
            if (fixed) {
                fixed = false;
                $('#to-top').hide("slow", function() {
                    $('#to-top').css({
                        display: 'none'
                    });
                });
            }
        }
    });


    var hash;

(function() {
   // your page initialization code here
   // the DOM will be available here
  var holder = document.getElementById('holder');
  var state = document.getElementById('status');

  if (typeof window.FileReader === 'undefined') {
    state.className = 'fail';
  } else {
    state.className = 'success';
  }

  document.getElementById('myInput').addEventListener('change', function(evt) {
      var f = evt.target.files[0];
      handleFileSelect(f);
    }, false);

  document.getElementById('verifyButton').onclick = function(e) {
    e.preventDefault();
    $('#alertMessage').hide();
    $('#successMessage').hide();
    $('#dangerMessage').hide();

    if(!hash) {
      alert("Select a document first");
      return;
    }
    var stamp;
    try {
      var stampString = document.getElementById('jsonstamp').value;
      console.log("verifyButton clicked");
      var stamp = JSON.parse(stampString);
      if(stamp.ots1) {
        stamp=stamp.ots1;
      }

    } catch(e) {}

    if(!stamp) {
      alert("Stamp data is not a valid");
      return;
    }
    verify(hash,stamp);
  }

})();

function danger(text) {
  $('#dangerMessage').show();
  $('#dangerMessage').html("<strong>FAIL!</strong> " +text);
}

function alert(text) {
  $('#alertMessage').show();
  $('#alertMessage').html("<strong>ALERT!</strong> " + text);
}


function success(text) {
  $('#successMessage').show();
  $('#successMessage').html("<strong>SUCCESS!</strong> " + text);
}


holder.ondragover = function () { this.className = 'hover'; return false; };
holder.ondragend = function () { this.className = ''; return false; };
holder.ondrop = function (e) {
  this.className = '';
  e.preventDefault();
  var file = e.dataTransfer.files[0];
  handleFileSelect(file);

  return false;
};

function status(text) {
    document.getElementById('status').innerText = text ;
}

function crypto_callback(p) {
    status('Hashing ' + (p*100).toFixed(0) + '% completed');
}

holder.onclick = function () {
    console.log("holder.onclick");

    document.getElementById('myInput').click(
    );
};

function humanFileSize(bytes, si) {
    var thresh = si ? 1000 : 1024;
    if(Math.abs(bytes) < thresh) {
        return bytes + ' B';
    }
    var units = si
        ? ['kB','MB','GB','TB','PB','EB','ZB','YB']
        : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
    var u = -1;
    do {
        bytes /= thresh;
        ++u;
    } while(Math.abs(bytes) >= thresh && u < units.length - 1);
    return bytes.toFixed(1)+' '+units[u];
}


function handleFileSelect(file) {
   document.getElementById('filename').innerText = file.name;
   document.getElementById('filesize').innerText = humanFileSize(file.size,true);

   reader = new FileReader();
   reader.onload = function (event) {

   var data = event.target.result;
   setTimeout(function() {
        CryptoJS.SHA256(data, crypto_callback, crypto_finish);
      }, 200);
   };
   console.log(file);
   reader.readAsBinaryString(file);
}


function verify(hash, stamp) {
  try {
    var stampPath=stamp[0];
    var stampEnd=stamp[1];
    var value = hash;
    for (var i = 1; i < stampPath.length; i++) {
      current = stampPath[i];
      console.log("value=" + value);
      value = exec(current[0], current[1], value, current[2]);
    }

    var finalValue = finalExec(stampEnd[0], stampEnd[1], stampEnd[2], value, stampEnd[3] )
    console.log("Block hash=" + finalValue);
    var finalValueBuffer = new bitcore.deps.Buffer(finalValue,"hex");
    var reversed = bitcore.util.buffer.reverse(finalValueBuffer).toString("hex");

    askBlock(reversed);

  } catch(e) {
    alert(e);
  }
}


function finalExec(what, chain, prefix, prec, suffix) {
  if( what=="block_header" && chain=="bitcoin-mainnet" ) {
    return exec("sha256",exec("sha256",prefix,prec,suffix),"","");
  } else {
    throw new Exception("error");
  }
}
function exec(what, prefix, prec, suffix) {
  value=new bitcore.deps.Buffer(prefix + prec + suffix, "hex");
  if("sha256" == what) {
    h=bitcore.crypto.Hash.sha256(value);
    return h.toString('hex');
  } else if("reverse" == what) {
    return bitcore.util.buffer.reverse(value).toString("hex");
  } else if("ripemd160" == what) {
    h=bitcore.crypto.Hash.ripemd160(value);
    return h.toString('hex');
  } else {
    throw new Exception("error");
  }
}


function crypto_finish(val) {
    hash=val;
    console.log("crypto_finish " + hash);
    status("Document hash is " + hash );

    /*document.getElementById('hashinput').value=hash ;*/

}

var blockProviders = ["https://insight.bitpay.com/api/block/",
"https://www.localbitcoinschain.com/api/block/",
//"https://blockchain.info/it/rawblock/",
"http://vr4.synaptica.info:3000/api/block/"];

var results = [];


function askBlock(hash) {
  var promises=[];
  for(var i = 0; i< blockProviders.length ; i++) {
    var url = blockProviders[i] + hash;
    var req = makeRequest({
      method:"GET",
      url:url,
      timeout: 5000
    });
    promises.push(req);
  }
  Promise.all(promises.map(softFail)).then(function(data) {
    var found=false;
    for(var i = 0; i< data.length ; i++) {
      try {
        var result=JSON.parse(data[i].response);
        var time = result['time'];
        console.log(time);
        if(results.indexOf(time)>=0) {
          console.log("found twice!");
          var a = new Date(time * 1000);
          success("Data was created on or before " + a);
          found=true;
        }
        results.push(time);
      } catch(e) {}
    }
    if(!found) {
      danger("Can't verify the stamp, block hash is " + hash);
    }

  });

}

function softFail(promise) {
  return new Promise(function(resolve, reject) {
    promise
    .then(resolve)
    .catch(resolve)
  })
}

function makeRequest (opts) {
  return new Promise(function (resolve, reject) {
    var now = Date.now();
    var xhr = new XMLHttpRequest();
    xhr.timeout= opts.timeout || 5000;
    xhr.open(opts.method, opts.url);
    xhr.onload = function () {
      if (this.status >= 200 && this.status < 300) {
        var data = {};
        data['response']= xhr.response;
        data['elapsed'] = Date.now() - now;
        resolve(data);
      } else {
        reject({
          status: this.status,
          statusText: xhr.statusText,
          m: "statusNot200",
          opts: opts,
          elapsed : Date.now() - now
        });
      }
    };
    xhr.onerror = function () {
      reject({
        status: this.status,
        statusText: xhr.statusText,
        m: "error",
        opts: opts,
        elapsed : Date.now() - now
      });
    };
    xhr.ontimeout = function () {
      reject({
        status: this.status,
        statusText: xhr.statusText,
        m: "timeout",
        opts: opts,
        elapsed : Date.now() - now
      });
    };
    if (opts.headers) {
      Object.keys(opts.headers).forEach(function (key) {
        xhr.setRequestHeader(key, opts.headers[key]);
      });
    }
    var params = opts.params;
    // We'll need to stringify if we've been given an object
    // If we have a string, this is skipped.
    if (params && typeof params === 'object') {
      params = Object.keys(params).map(function (key) {
        return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
      }).join('&');
    }
    xhr.send(params);
  });
}


    </script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-64322985-8', 'auto');
      ga('send', 'pageview');

    </script>
</body>

</html>
