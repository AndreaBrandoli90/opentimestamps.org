<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>OpenTimestamps</title>

    <!-- Bootstrap Core CSS -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">-->
    <!-- Bootstrap Core CSS LOCAL-->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/stylish-portfolio.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,700,300italic,400italic,700italic" rel="stylesheet" type="text/css">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>

  <div class="beta-banner-wrapper">
      <div class="beta-banner">
        <span>Beta</span>
      </div>
    </div>

    <!-- Navigation -->
    <a id="menu-toggle" href="#" class="btn btn-dark btn-lg toggle"><i class="fa fa-bars"></i></a>

    <nav id="sidebar-wrapper">
        <ul class="sidebar-nav">
            <a id="menu-close" href="#" class="btn btn-light btn-lg pull-right toggle"><i class="fa fa-times"></i></a>
            <li class="sidebar-brand">
                <a href="#top" onclick=$("#menu-close").click();>OpenTimestamps</a>
            </li>
            <li>
                <a href="#top" onclick=$("#menu-close").click();>Home</a>
            </li>
            <li>
                <a href="#about" onclick=$("#menu-close").click();>About</a>
            </li>
            <li>
                <a href="#stampandverify" onclick=$("#menu-close").click();>Stamp and Verify</a>
            </li>
            <li>
                <a href="#howitworks" onclick=$("#menu-close").click();>How it works?</a>
            </li>
            <li>
                <a href="#vendors" onclick=$("#menu-close").click();>Vendors</a>
            </li>
            <li>
                <a href="#repositories" onclick=$("#menu-close").click();>Repositories</a>
            </li>
            <li>
                <a href="http://lists.opentimestamps.org/mailman/listinfo/ots-announce" onclick=$("#menu-close").click();>Mailing list</a>
            </li>
            <li>
                <a href="#usecases" onclick=$("#menu-close").click();>Use cases</a>
            </li>
        </ul>
    </nav>

    <!-- Header -->
    <header id="top" class="header">
        <div class="text-vertical-center">
          <div class="title">
            <h1>Open<wbr>Timestamps</h1>
            <h3>A timestamping proof standard</h3>
          </div>
        </div>
    </header>

    <!-- About -->
    <section id="about" class="about">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">

                    <p class="lead">OpenTimestamps aims to be a standard format for blockchain timestamping.<br>
                      The format is flexible enough to be vendor and blockchain independent.
                    </p>
                </div>
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
    </section>

    <!-- Services -->
    <!-- The circle icons use Font Awesome's stacked icon classes. For more information, visit http://fontawesome.io/examples/ -->
    <section id="services" class="services bg-primary">
        <div class="container">
            <div class="row text-center">

                        <div class="col-lg-4 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-check fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Stamp &amp; Verify</strong>
                                </h4>
                                <p>
                                  Use the in-browser stamper and verifier

                                </p>
                                <a href="#stampandverify" class="btn btn-light">STAMP &amp; VERIFY</a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-question fa-stack-1x text-primary"></i>
                                </span>

                                <h4>
                                    <strong>How it works?</strong>
                                </h4>
                                <p>Details on OpenTimestamps</p>
                                <a href="#howitworks" class="btn btn-light">HOW IT WORKS</a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-flask fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Vendors</strong>
                                </h4>
                                <p>Company using OpenTimestamps</p>
                                <a href="#vendors" class="btn btn-light">VENDORS</a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-book fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Repositories</strong>
                                </h4>
                                <p>OpenTimestamps repositories</p>
                                <a href="#repositories" class="btn btn-light">REPOSITORIES</a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-envelope fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Mailing list</strong>
                                </h4>
                                <p>OpenTimestamps announcements</p>
                                <a href="http://lists.opentimestamps.org/mailman/listinfo/ots-announce" class="btn btn-light">MAILING LIST</a>
                            </div>
                        </div>
                        <div class="col-lg-4 col-sm-6">
                            <div class="service-item">
                                <span class="fa-stack fa-4x">
                                <i class="fa fa-circle fa-stack-2x"></i>
                                <i class="fa fa-lightbulb-o fa-stack-1x text-primary"></i>
                            </span>
                                <h4>
                                    <strong>Use cases</strong>
                                </h4>
                                <p>What can you do with timestamping?</p>
                                <a href="#usecases" class="btn btn-light">USE CASES</a>
                            </div>
                        </div>
                </div>
            </div>
        </section>




    <section id="stampandverify">
        <div class="container">
            <div class="row">
                <div class="col-lg-10 col-lg-offset-1 text-center">
                    <br><h2>Stamp</h2>
                    <hr class="small">
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <div>
                                <h3>Data to timestamp<a href="#verify" data-toggle="tooltip" title="The hash is calculated on your browser preserving your privacy"><upper>*</upper></a></h3>

                                <div id="document_holder" class="holder" >
                                    <div class="text-center">
                                        <br><span id="document_filename">Drop here a document</span>
                                        <br><span id="document_filesize">Or click to select one</span>
                                    </div>
                                </div>
                                <input id="document_input" type="file" style="display:none">
                            </div>
                        </div>
                    </div>

                    <br><a href="#" class="btn btn-dark" id="stampButton">STAMP</a>
                    <br><br>

                    <br><h2>Verify</h2>
                    <p>In-browser verification is to be considered for testing purpose only.
                        <br>for proven security system use <a href="https://github.com/opentimestamps/opentimestamps-client">OpenTimestamps client</a></p>
                    <hr class="small">
                    <div class="row">
                        <div class="col-sm-6">
                            <div>
                                <h3>Timestamped data <a href="#verify" data-toggle="tooltip" title="The hash is calculated on your browser preserving your privacy"><upper>*</upper></a></h3>

                                <div id="stamped_holder" class="holder" >
                                    <div class="text-center">
                                        <br><span id="stamped_filename">Drop here a document</span>
                                        <br><span id="stamped_filesize">Or click to select one</span>
                                    </div>
                                </div>
                                <input id="stamped_input" type="file" style="display:none">
                            </div>
                        </div>
                        <div class="col-sm-6">
                            <div>
                                <h3>Open<wbr>Timestamps Proof</h3>
                                <div id="proof_holder" class="holder" >
                                    <div class="text-center">
                                        <br><span id="proof_filename">Drop here the OpenTimestamps Proof</span>
                                        <br><span id="proof_filesize">Or click to select one</span>
                                    </div>
                                </div>
                                <input id="proof_input" type="file" style="display:none">
                            </div>
                        </div>
                    </div>
                    <!-- /.row (nested) -->
                    <p id="status" class="wrap"></p>
                    <p id="status2" class="wrap" style="margin-bottom: 0px"></p>
                    <br><a href="#" class="btn btn-dark" id="verifyButton">VERIFY</a>
                    <br><br>
                    <div id="loading" style="display:none">
                      <i class="fa fa-cog fa-spin fa-3x fa-fw"></i>
                      <span class="sr-only">Loading...</span>
                    </div>
                    <div class="alert alert-warning" role="alert" id="alertMessage" style="display:none">
                    </div>
                    <div class="alert alert-success" role="alert" id="successMessage" style="display:none">
                    </div>
                    <div class="alert alert-danger" role="alert" id="dangerMessage" style="display:none">
                    </div>

                </div>
                <!-- /.col-lg-10 -->
            </div>
            <!-- /.row -->
        </div>
        <!-- /.container -->
        <br><br>
    </section>


  <!-- Footer -->
  <footer>
      <div class="container">
          <div class="row">
              <div class="col-lg-10 col-lg-offset-1 text-center">
                  <h4><strong>OpenTimestamps</strong>
                  </h4>

                  <ul class="list-unstyled">

                      <li><i class="fa fa-envelope-o fa-fw"></i>
                          <a href="mailto:info@opentimestamps.org">info@opentimestamps.org</a>
                      </li>
                  </ul>
                  <br>
                  <ul class="list-inline">

                      <li>
                          <a href="https://github.com/RCasatta/web-opentimestamps/tree/gh-pages"><i class="fa fa-github fa-fw fa-3x"></i></a>
                      </li>
                  </ul>
                  <hr class="small">

              </div>
          </div>
      </div>
      <a id="to-top" href="#top" class="btn btn-dark btn-lg"><i class="fa fa-chevron-up fa-fw fa-1x"></i></a>
  </footer>

  <!-- jQuery -->
  <script src="js/jquery.js"></script>

  <script src="bower_components/bitcore-lib/bitcore-lib.min.js"></script>

  <!-- Bootstrap Core JavaScript -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/crypto.js"></script>

  <!-- Custom Theme JavaScript -->
  <script>
      var bitcore = require('bitcore-lib');


      $(document).ready(function(){
          $('[data-toggle="tooltip"]').tooltip();
      });

      // Closes the sidebar menu
      $("#menu-close").click(function(e) {
          e.preventDefault();
          $("#sidebar-wrapper").toggleClass("active");
      });
      // Opens the sidebar menu
      $("#menu-toggle").click(function(e) {
          e.preventDefault();
          $("#sidebar-wrapper").toggleClass("active");
      });
      // Scrolls to the selected menu item on the page
      $(function() {
          $('a[href*=#]:not([href=#],[data-toggle],[data-target],[data-slide])').click(function() {
              if (location.pathname.replace(/^\//, '') == this.pathname.replace(/^\//, '') || location.hostname == this.hostname) {
                  var target = $(this.hash);
                  target = target.length ? target : $('[name=' + this.hash.slice(1) + ']');
                  if (target.length) {
                      $('html,body').animate({
                          scrollTop: target.offset().top
                      }, 1000);
                      return false;
                  }
              }
          });
      });
      //#to-top button appears after scrolling
      var fixed = false;
      $(document).scroll(function() {
          if ($(this).scrollTop() > 250) {
              if (!fixed) {
                  fixed = true;
                  // $('#to-top').css({position:'fixed', display:'block'});
                  $('#to-top').show("slow", function() {
                      $('#to-top').css({
                          position: 'fixed',
                          display: 'block'
                      });
                  });
              }
          } else {
              if (fixed) {
                  fixed = false;
                  $('#to-top').hide("slow", function() {
                      $('#to-top').css({
                          display: 'none'
                      });
                  });
              }
          }
      });



      (function() {
          // your page initialization code here
          // the DOM will be available here


          var state = document.getElementById('status');

          if (typeof window.FileReader === 'undefined') {
              state.className = 'fail';
          } else {
              state.className = 'success';
          }


          /*document.getElementById('verifyButton1').onclick = function (e) {
              console.log("verifyButton : onclick");
              e.preventDefault();
              $('#loading').show();
              $('#status2').hide();
              $('#alertMessage').hide();
              $('#successMessage').hide();
              $('#dangerMessage').hide();
              /*if (!hash) {
               alert("Select a document first");
               return;
               }
              // Validation input fields

              var stamp;
              try {
                  var stampString = document.getElementById('jsonstamp').value;
                  console.log("verifyButton clicked");
                  var stamp = JSON.parse(stampString);
                  if (stamp.ots1) {
                      stamp = stamp.ots1;
                  }
                  if (stamp.OpenTimestamps.path) {
                      stamp = stamp.OpenTimestamps.path;
                  }

              } catch (e) {
                  console.log("cannot parse as json, trying removing first two lines");
                  try {
                      //remove first two lines and retry
                      var splitted = stampString.split("\n");
                      var firstTwoRemoved = splitted.slice(2, splitted.length).join("\n");
                      stamp = JSON.parse(firstTwoRemoved);
                  } catch (e2) {
                      console.log("cannot parse as json removing first two lines");
                      try {
                          var splitted = stampString.split("\n");
                          var firstThreeRemoved = splitted.slice(3, splitted.length).join("\n");
                          stamp = JSON.parse(firstThreeRemoved);
                      } catch (e3) {
                          console.log("cannot parse as json removing first three lines");
                      }
                  }
              }

              if (!stamp) {
                  alert("Stamp data is not a valid");
                  return;
              }
              verify(hash, stamp);
          }
*/

          /*
           *Document section
           events handle to easy file uploading : drop, drag-over, drag-leave, click, file change
           */
          $("#document_holder").on("drop", function(event) {
              event.preventDefault();
              event.stopPropagation();
              this.className = '';
              var file = event.originalEvent.dataTransfer.files[0];
              document_handleFileSelect(file);
              return false;
          });
          $("#document_holder").on("dragover", function(event) {
              event.preventDefault();
              event.stopPropagation();
              $(this).addClass('hover');
              return false;
          });

          $("#document_holder").on("dragleave", function(event) {
              event.preventDefault();
              event.stopPropagation();
              $(this).removeClass('holder');
              $(this).removeClass('hover');
              return false;
          });
          $("#document_holder").click(function(event) {
              console.log("document_holder : click");
              event.preventDefault();
              event.stopPropagation();
              document.getElementById('document_input').click();
              return false;
          });
          $("#document_input").change(function(event) {
              console.log("document_input : change");
              var f = event.target.files[0];
              document.getElementById('document_filename').innerText = f.name;
              document.getElementById('document_filesize').innerText = humanFileSize(f.size, true);
              document_handleFileSelect(f);
          });

          $("#stampButton").click(function(event) {
              if(filename!="" && hashfile!="") {
                  stamp(filename, hashfile);
              }
          });


          /* Stamped section */
          $("#stamped_holder").on("drop", function(event) {
              event.preventDefault();
              event.stopPropagation();
              this.className = '';
              var file = event.originalEvent.dataTransfer.files[0];
              stamped_handleFileSelect(file);
              return false;
          });
          $("#stamped_holder").on("dragover", function(event) {
              event.preventDefault();
              event.stopPropagation();
              $(this).addClass('hover');
              return false;
          });

          $("#stamped_holder").on("dragleave", function(event) {
              event.preventDefault();
              event.stopPropagation();
              $(this).removeClass('holder');
              $(this).removeClass('hover');
              return false;
          });
          $("#stamped_holder").click(function(event) {
              event.preventDefault();
              event.stopPropagation();
              document.getElementById('stamped_holder').click();
              return false;
          });
          $("#stamped_holder").change(function(event) {
              var f = event.target.files[0];
              document.getElementById('stamped_filename').innerText = f.name;
              document.getElementById('stamped_filesize').innerText = humanFileSize(f.size, true);
              stamped_handleFileSelect(f);
          });

          /* Proof section */
          $("#proof_holder").on("drop", function(event) {
              event.preventDefault();
              event.stopPropagation();
              this.className = '';
              var file = event.originalEvent.dataTransfer.files[0];
              proof_handleFileSelect(file);
              return false;
          });
          $("#proof_holder").on("dragover", function(event) {
              event.preventDefault();
              event.stopPropagation();
              $(this).addClass('hover');
              return false;
          });

          $("#proof_holder").on("dragleave", function(event) {
              event.preventDefault();
              event.stopPropagation();
              $(this).removeClass('holder');
              $(this).removeClass('hover');
              return false;
          });
          $("#proof_holder").click(function(event) {
              event.preventDefault();
              event.stopPropagation();
              document.getElementById('proof_holder').click();
              return false;
          });
          $("#proof_holder").change(function(event) {
              var f = event.target.files[0];
              document.getElementById('proof_filename').innerText = f.name;
              document.getElementById('proof_filesize').innerText = humanFileSize(f.size, true);
              proof_handleFileSelect(f);
          });

          $("#verifyButton").click(function(event) {
              if(proof!="" && stamped!="") {
                  verify(proof, stamped);
              }
          });


          /*var stamped_holder = document.getElementById('stamped_holder');
           stamped_holder.ondragover = function () { this.className = 'holder hover'; return false; };
           stamped_holder.ondragend = function () { this.className = ''; return false; };
           stamped_holder.onclick = function () {
           console.log("holder.onclick");
           document.getElementById('stamped_input').click();
           };

           stamped_holder.ondrop = function (e) {
           console.log("stamped_input : drop");
           this.className = '';
           e.preventDefault();
           var file = e.dataTransfer.files[0];
           handleFileSelect("stamped",file);
           return false;
           };

           document.getElementById('stamped_input').addEventListener('change', function (evt) {
           console.log("stamped_input : change");
           var f = evt.target.files[0];
           handleFileSelect("stamped",f);
           }, false);

           /* Proof section */
          /*var proof_holder = document.getElementById('proof_holder');
           proof_holder.ondragover = function () { this.className = 'holder hover'; return false; };
           proof_holder.ondragend = function () { this.className = ''; return false; };
           proof_holder.onclick = function () {
           console.log("holder.onclick");
           document.getElementById('proof_input').click();
           };

           proof_holder.ondrop = function (e) {
           console.log("proof_input : drop");
           this.className = '';
           e.preventDefault();
           var file = e.dataTransfer.files[0];
           handleFileSelect("proof",file);
           return false;
           };

           document.getElementById('proof_input').addEventListener('change', function (evt) {
           console.log("proof_input : change");
           var f = evt.target.files[0];
           handleFileSelect("proof",f);
           }, false);
           */

      })();




      /*
       * HANDLE UPLOADED FILE
       */
      var hashfile="";
      var filename="";
      // Hash file generation : save the hash in the hashfile global variable
      function document_handleFileSelect(file) {
          // Read and crypt the file
          let reader = new FileReader();
          reader.onload = function (event) {
              var data = event.target.result;
              setTimeout(function () {
                  CryptoJS.SHA256(data, crypto_callback, crypto_finish);
              }, 200);
          };
          console.log(file);
          reader.readAsBinaryString(file);

          function crypto_callback(p) {
              status('Hashing ' + (p*100).toFixed(0) + '% completed');
          }

          function crypto_finish(hash) {
              hashfile = ""+hash+"";
              filename = file.name;
              console.log("crypto_finish " + hash);
              status("Document hash is " + hash);
          }
      }

      var stamped="";
      var proof="";
      function stamped_handleFileSelect(file) {
          // Read and crypt the file
          let reader = new FileReader();
          reader.onload = function (event) {
              var data = event.target.result;
              stamped = ""+data+"";
              console.log("stamped: " + stamped);
          };
          reader.readAsBinaryString(file);
      }
      function proof_handleFileSelect(file) {
          // Read and crypt the file
          let reader = new FileReader();
          reader.onload = function (event) {
              var data = event.target.result;
              proof = ""+data+"";
              console.log("proof: " + proof);
          };
          reader.readAsBinaryString(file);
      }



      /*
       * COMMON FUNCTIONS
       */
      // Human file size
      function humanFileSize(bytes, si) {
          var thresh = si ? 1000 : 1024;
          if(Math.abs(bytes) < thresh) {
              return bytes + ' B';
          }
          var units = si
                  ? ['kB','MB','GB','TB','PB','EB','ZB','YB']
                  : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
          var u = -1;
          do {
              bytes /= thresh;
              ++u;
          } while(Math.abs(bytes) >= thresh && u < units.length - 1);
          return bytes.toFixed(1)+' '+units[u];
      }

      // Download file
      function download(filename, text) {
          var element = document.createElement('a');
          element.setAttribute("target","_blank");
          element.href = window.URL.createObjectURL(new Blob([text], {type: 'text'}));
          element.download = filename+".ots";
          document.getElementById('status').appendChild(element);
          element.click();
          $('status').show();

      }

      function string2Bin(str) {
          var result = [];
          for (var i = 0; i < str.length; i++) {
              result.push(str.charCodeAt(i));
          }
          return result;
      }

      function bin2String(array) {
          return String.fromCharCode.apply(String, array);
      }


      /*
       * STATUS ALERT MESSAGES
       */
      function danger(text) {
          $('#loading').hide();
          $('#dangerMessage').show();
          $('#dangerMessage').html("<strong>FAIL!</strong> " +text);
      }

      function alert(text) {
          $('#loading').hide();
          $('#alertMessage').show();
          $('#alertMessage').html("<strong>ALERT!</strong> " + text);
      }


      function success(text) {
          $('#loading').hide();
          $('#successMessage').show();
          $('#successMessage').html("<strong>SUCCESS!</strong> " + text);
      }

      function status(text) {
          document.getElementById('status').innerText = text ;
      }

      /*
       * VERIFY FILE
       */
      function verify1(hash, stamp) {
          try {
              var stampHash=stamp[0]
              var merklePathOperations=stamp[1];
              var timestampSignature=stamp[2];
              if(hash!=stampHash) {
                  alert("Document hash and stamp hash does not match.")
                  return;
              }

              var value = hash;
              for (var i = 1; i < merklePathOperations.length; i++) {
                  current = merklePathOperations[i];
                  console.log("value=" + value);
                  value = exec(current[0], current[1], value, current[2]);
              }

              var finalValue = finalExec(timestampSignature[0], timestampSignature[1], timestampSignature[2], value, timestampSignature[3] )

              console.log("Block hash=" + finalValue);
              var finalValueBuffer = new bitcore.deps.Buffer(finalValue,"hex");
              var reversed = bitcore.util.buffer.reverse(finalValueBuffer).toString("hex");
              $('#status2').text("Block hash is " + reversed);
              $('#status2').show();
              askBlock(reversed);

          } catch(e) {
              alert(e);
          }
      }


      function finalExec(what, chain, prefix, prec, suffix) {
          if( what=="block_header" && chain=="bitcoin-mainnet" ) {
              return exec("sha256",exec("sha256",prefix,prec,suffix),"","");
          } else {
              throw new Exception("error");
          }
      }
      function exec(what, prefix, prec, suffix) {
          value=new bitcore.deps.Buffer(prefix + prec + suffix, "hex");
          if("sha256" == what) {
              h=bitcore.crypto.Hash.sha256(value);
              return h.toString('hex');
          } else if("reverse" == what) {
              return bitcore.util.buffer.reverse(value).toString("hex");
          } else if("ripemd160" == what) {
              h=bitcore.crypto.Hash.ripemd160(value);
              return h.toString('hex');
          } else {
              throw new Exception("error");
          }
      }


      /* BLOCKS REQUEST */

      var blockProviders = ["https://insight.bitpay.com/api/block/",
          "https://www.localbitcoinschain.com/api/block/",
//"https://blockchain.info/it/rawblock/",
          "http://vr4.synaptica.info:3000/api/block/"];

      var results = [];


      function askBlock(hash) {
          var promises=[];
          for(var i = 0; i< blockProviders.length ; i++) {
              var url = blockProviders[i] + hash;
              var req = makeRequest({
                  method:"GET",
                  url:url,
                  timeout: 5000
              });
              promises.push(req);
          }
          Promise.all(promises.map(softFail)).then(function(data) {
              var found=false;
              for(var i = 0; i< data.length ; i++) {
                  try {
                      var result=JSON.parse(data[i].response);
                      var time = result['time'];
                      console.log(time);
                      if(results.indexOf(time)>=0) {
                          console.log("found twice!");
                          var a = new Date(time * 1000);
                          success("Data was created on or before " + a);
                          found=true;
                      }
                      results.push(time);
                  } catch(e) {}
              }
              if(!found) {
                  danger("Can't verify the block hash with a block explorer (maybe connection problem).<br>You should manually verify the block hash");
              }

          });

      }

      function softFail(promise) {
          return new Promise(function(resolve, reject) {
              promise
                      .then(resolve)
                      .catch(resolve)
          })
      }

      function makeRequest (opts) {
          return new Promise(function (resolve, reject) {
              var now = Date.now();
              var xhr = new XMLHttpRequest();


              xhr.timeout= opts.timeout || 5000;
              xhr.open(opts.method, opts.url);
              xhr.onload = function () {
                  if (this.status >= 200 && this.status < 300) {
                      var data = {};
                      data['response']= xhr.response;
                      data['elapsed'] = Date.now() - now;
                      resolve(data);
                  } else {
                      reject({
                          status: this.status,
                          statusText: xhr.statusText,
                          m: "statusNot200",
                          opts: opts,
                          elapsed : Date.now() - now
                      });
                  }
              };
              xhr.onerror = function () {
                  reject({
                      status: this.status,
                      statusText: xhr.statusText,
                      m: "error",
                      opts: opts,
                      elapsed : Date.now() - now
                  });
              };
              xhr.ontimeout = function () {
                  reject({
                      status: this.status,
                      statusText: xhr.statusText,
                      m: "timeout",
                      opts: opts,
                      elapsed : Date.now() - now
                  });
              };
              if (opts.headers) {
                  Object.keys(opts.headers).forEach(function (key) {
                      xhr.setRequestHeader(key, opts.headers[key]);
                  });
              }
              var params = opts.params;
              // We'll need to stringify if we've been given an object
              // If we have a string, this is skipped.
              if (params && typeof params === 'object') {
                  params = Object.keys(params).map(function (key) {
                      return encodeURIComponent(key) + '=' + encodeURIComponent(params[key]);
                  }).join('&');
              }
              xhr.send(params);
          });
      }
      function urandom(tot)
      {
          var text = "";
          var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";

          for( var i=0; i < tot; i++ )
              text += possible.charAt(Math.floor(Math.random() * possible.length));

          return text;
      }





  </script>
  <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
              m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-64322985-8', 'auto');
      ga('send', 'pageview');


  </script>

  <!-- OPENTIMESTAMPS LIBRARY -->
  <!-- build by: browserify -r javascript-opentimestamps -r bytebuffer script.js -o bundle.js
  fix 232 lines:
getOutput() {
  const output = this.buffer.view.subarray(0, this.buffer.offset);
  return output;
}
  -->
  <script src="bundle.js"></script>
  <script>

      const OpenTimestamps = require('javascript-opentimestamps');
      const ByteBuffer = require('bytebuffer');


      // Stamp the hash of the file
      function stamp(filename, hash) {
          console.log("INFO");
          const file = ByteBuffer.fromHex(hash).buffer;
          const timestampBytesPromise = OpenTimestamps.stamp(file);
          timestampBytesPromise.then(timestampBytes =>
          {
              console.log('STAMP result : ');
          console.log(timestampBytes);
          let output = "";
          for (let i = 0; i < timestampBytes.length; i++)
              output += String.fromCharCode(timestampBytes[i]);
          download(filename, output);
      }
      )
      ;
      }

      function verify(ots, file) {
          console.log("VERIFY");
          const bytesOts = ByteBuffer.fromBinary(ots).buffer;
          const bytesFile = ByteBuffer.fromBinary(file).buffer;

          const verifyPromise = OpenTimestamps.verify(bytesOts, bytesFile);
          verifyPromise.then(result => {
              console.log('VERIFY result : ' + result);
      }
      ).catch(err => {
          console.log(err);
      })
      ;
      }
  </script>
</body>
</html>


